
# Plan: Restructure Image Gallery with Purpose-Based Tabs & AI Studio Integration

## Summary

This plan implements a major UI overhaul of the Image Search Gallery, consolidating the current 6 vendor-specific tabs (All, Openverse, Unsplash, Pexels, Pixabay, Wikimedia) into 4 purpose-based tabs, and adding a new AI image generation feature via Pollinations.ai.

---

## Current State Analysis

### Current Tab Structure (6 tabs)
```
[All] [Openverse] [Unsplash] [Pexels] [Pixabay] [Wikimedia]
```

**Problems:**
- Cluttered with too many vendor-specific tabs
- Users don't care about the vendorâ€”they care about the *type* of image
- No AI generation option when stock fails

### Current Backend (`search-book-images/index.ts`)
- Already categorizes by source (unsplash, pexels, pixabay, wikimedia, openverse)
- Already has `searchMode` detection (abstract/realistic/mixed)
- Already has `imageType` parameter for Pixabay vectors

---

## Proposed Tab Structure (4 purpose-based tabs)

```
+-------------------------------------------------------------------+
| [Gallery]  [Locations & Landmarks]  [Vectors & Icons]  [AI Studio] |
+-------------------------------------------------------------------+
```

| Tab | Source | Purpose |
|-----|--------|---------|
| **Gallery** (Default) | Unsplash + Pexels + Pixabay (photos) | High-quality stock photos for general vibes |
| **Locations & Landmarks** | Openverse + Wikimedia | Specific hotels, towns, editorial content |
| **Vectors & Icons** | Pixabay (vectors only) | Diagrams, astrology symbols, logos |
| **AI Studio** | Pollinations.ai | Custom generation when stock fails |

---

## Implementation Plan

### Part 1: Update Frontend Tab Structure

**File: `src/components/ImageSearchGallery.tsx`**

**1A. Change Tab Definitions**

Replace the current 6-tab structure with 4 purpose-based tabs:

```typescript
// NEW: Group images by purpose, not vendor
const galleryImages = images.filter(img => 
  img.source === 'unsplash' || img.source === 'pexels' || 
  (img.source === 'pixabay' && !img.license?.includes('vector'))
);

const locationsImages = images.filter(img => 
  img.source === 'openverse' || img.source === 'wikimedia'
);

const vectorImages = images.filter(img => 
  img.source === 'pixabay' && img.imageUrl?.includes('vector')
);
```

**1B. New Tab UI**

```tsx
<Tabs defaultValue="gallery" className="h-full flex flex-col">
  <TabsList className="grid w-full grid-cols-4 mb-2">
    <TabsTrigger value="gallery">Gallery ({galleryImages.length})</TabsTrigger>
    <TabsTrigger value="locations">Locations ({locationsImages.length})</TabsTrigger>
    <TabsTrigger value="vectors">Vectors ({vectorImages.length})</TabsTrigger>
    <TabsTrigger value="ai-studio">AI Studio</TabsTrigger>
  </TabsList>
  
  {/* Tab contents... */}
</Tabs>
```

**1C. Add AI Studio Tab Content**

```tsx
<TabsContent value="ai-studio" className="flex-1 min-h-0 mt-0">
  <AiStudioPanel 
    initialPrompt={query}
    onSelectImage={(imageUrl) => {
      // Create AI-generated image result
      const aiImage: ImageResult = {
        id: `pollinations-${Date.now()}`,
        imageUrl,
        thumbnailUrl: imageUrl,
        attribution: 'Generated by Pollinations.ai (Flux Model)',
        source: 'pollinations' as any, // New source type
        width: 1024,
        height: 1024,
        isPrintReady: true,
        license: 'Public Domain',
      };
      setSelectedImage(aiImage);
    }}
  />
</TabsContent>
```

---

### Part 2: Create AI Studio Panel Component

**File: `src/components/ImageSearchGallery.tsx` (inline component)**

New `AiStudioPanel` component with:

**2A. State**
```typescript
const [aiPrompt, setAiPrompt] = useState(initialPrompt);
const [selectedStyle, setSelectedStyle] = useState('photorealistic');
const [generatedImageUrl, setGeneratedImageUrl] = useState<string | null>(null);
const [isGenerating, setIsGenerating] = useState(false);
const [cooldown, setCooldown] = useState(0); // 5-second cooldown
```

**2B. Style Presets**
```typescript
const STYLE_PRESETS = {
  'watercolor': 'watercolor style, white background, artistic',
  'photorealistic': 'highly detailed, 8k, realistic',
  'lineart': 'black and white, vector line art, minimal',
};
```

**2C. Generate Handler**
```typescript
const handleGenerate = () => {
  if (cooldown > 0 || !aiPrompt.trim()) return;
  
  setIsGenerating(true);
  
  // Build final prompt with style suffix
  const styleAppendix = STYLE_PRESETS[selectedStyle];
  const fullPrompt = `${aiPrompt.trim()}, ${styleAppendix}`;
  
  // Construct Pollinations URL
  const encodedPrompt = encodeURIComponent(fullPrompt);
  const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1024&height=1024&model=flux&nologo=true`;
  
  setGeneratedImageUrl(url);
  setIsGenerating(false);
  
  // Start 5-second cooldown
  setCooldown(5);
  const interval = setInterval(() => {
    setCooldown(prev => {
      if (prev <= 1) {
        clearInterval(interval);
        return 0;
      }
      return prev - 1;
    });
  }, 1000);
};
```

**2D. UI Layout**
```tsx
<div className="p-4 space-y-4">
  <div className="text-center space-y-2">
    <Sparkles className="w-8 h-8 mx-auto text-primary" />
    <h3 className="font-semibold">AI Studio</h3>
    <p className="text-xs text-muted-foreground">
      Generate custom images when stock photos fail
    </p>
  </div>
  
  {/* Prompt Input */}
  <Textarea
    value={aiPrompt}
    onChange={(e) => setAiPrompt(e.target.value)}
    placeholder="Describe your ideal image..."
    className="min-h-[80px]"
  />
  
  {/* Style Selector */}
  <Select value={selectedStyle} onValueChange={setSelectedStyle}>
    <SelectTrigger>
      <SelectValue placeholder="Select style..." />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="watercolor">Watercolor Sketch</SelectItem>
      <SelectItem value="photorealistic">Photorealistic</SelectItem>
      <SelectItem value="lineart">Line Art / Diagram</SelectItem>
    </SelectContent>
  </Select>
  
  {/* Generate Button with Cooldown */}
  <Button 
    onClick={handleGenerate} 
    disabled={!aiPrompt.trim() || cooldown > 0}
    className="w-full gap-2"
  >
    {cooldown > 0 ? (
      <>Cooldown ({cooldown}s)</>
    ) : (
      <>
        <Wand2 className="w-4 h-4" />
        Generate Image
      </>
    )}
  </Button>
  
  {/* Preview */}
  {generatedImageUrl && (
    <div className="border rounded-lg overflow-hidden">
      <img 
        src={generatedImageUrl} 
        alt="AI Generated" 
        className="w-full h-auto"
        onLoad={() => setIsGenerating(false)}
      />
      <Button 
        onClick={() => onSelectImage(generatedImageUrl)}
        className="w-full rounded-t-none"
      >
        <Check className="w-4 h-4 mr-2" />
        Insert into Book
      </Button>
    </div>
  )}
</div>
```

---

### Part 3: Update Source Type & Metadata

**File: `src/components/ImageSearchGallery.tsx`**

**3A. Extend ImageResult interface**
```typescript
interface ImageResult {
  // ... existing fields
  source: 'unsplash' | 'wikimedia' | 'pexels' | 'pixabay' | 'openverse' | 'pollinations';
}
```

**3B. Update ImageSelectMetadata**
```typescript
export interface ImageSelectMetadata {
  source: 'unsplash' | 'pexels' | 'wikimedia' | 'pixabay' | 'openverse' | 'pollinations';
  // ... rest unchanged
}
```

**3C. Update getLicenseForSource**
```typescript
case 'pollinations': return 'Public Domain (Pollinations.ai)';
```

**3D. Update getSourceDisplayName**
```typescript
case 'pollinations': return 'Pollinations.ai';
```

---

### Part 4: Update Legal Documents

**File: `src/components/KdpLegalDefense.tsx`**

**4A. Update RTF Declaration (Section 2)**

Add Pollinations to the image licensing list:
```typescript
rtf += `\\tab - \\b AI Image Generation (Pollinations.ai): \\b0 Powered by the Flux model. Generated assets are Public Domain and cleared for commercial use.\\par`;
```

**4B. Update PDF Evidence Dossier**

Add new Section 7 for Pollinations:
```typescript
// Check page break before Pollinations section
if (y > 9.0) {
  doc.addPage();
  y = 1.0;
}

// 7. AI IMAGE GENERATION (Pollinations)
doc.setFont("times", "bold");
doc.text("7. AI Image Generation (Pollinations.ai)", 1, y);
y += 0.2;
doc.setFont("times", "normal");
doc.text("Source: Pollinations.ai (Flux Model)", 1, y);
y += 0.2;
doc.setFont("times", "italic");
const pollinationsQuote = "\"Pollinations generates images using the Flux model. All generated images are released into the Public Domain with no restrictions on commercial use. No attribution is required.\"";
const splitPollinations = doc.splitTextToSize(pollinationsQuote, 6.5);
doc.text(splitPollinations, 1, y);
y += (splitPollinations.length * 0.2) + 0.1;

doc.setFont("times", "normal");
doc.text("Usage: AI-generated for custom content, Public Domain.", 1, y);
y += 0.2;

doc.setTextColor(0, 0, 255);
doc.setFontSize(9);
doc.text("URL: https://pollinations.ai/", 1, y);
doc.setTextColor(0, 0, 0);
doc.setFontSize(10);
```

**4C. Update Image Manifest Source Mapping**

In the manifest table source display logic:
```typescript
case 'pollinations': sourceDisplay = 'Pollinations AI'; break;
```

---

### Part 5: Update Backend (Optional Enhancement)

**File: `supabase/functions/search-book-images/index.ts`**

Add a new `category` parameter to allow frontend to request specific source groups:

```typescript
const { query, orientation, limit, bookTopic, forCover, category } = await req.json();

// category: 'gallery' | 'locations' | 'vectors' | undefined
if (category === 'gallery') {
  // Only search Unsplash, Pexels, Pixabay (photos)
} else if (category === 'locations') {
  // Only search Openverse, Wikimedia
} else if (category === 'vectors') {
  // Only search Pixabay with image_type='vector'
}
```

**Note:** This is optional - the frontend can filter results client-side initially. Backend optimization can be done later for performance.

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/components/ImageSearchGallery.tsx` | 1) Restructure tabs from 6 vendor tabs to 4 purpose tabs; 2) Add AI Studio panel component; 3) Update source types to include 'pollinations' |
| `src/components/KdpLegalDefense.tsx` | 1) Add Pollinations to RTF Declaration; 2) Add Section 7 to PDF Evidence Dossier; 3) Update Image Manifest source mapping |

---

## Visual Changes

### Before (Current)
```
+----------------------------------------------------------------+
| [All] [Openverse] [Unsplash] [Pexels] [Pixabay] [Wikimedia]     |
+----------------------------------------------------------------+
```

### After (Proposed)
```
+----------------------------------------------------------------+
| [Gallery]  [Locations & Landmarks]  [Vectors & Icons]  [AI Studio] |
+----------------------------------------------------------------+
```

### AI Studio Tab
```
+--------------------------------+
|          âœ¨ AI Studio          |
|  Generate custom images when   |
|     stock photos fail          |
|                                |
| Prompt:                        |
| [A sunset over Lake Como... ]  |
|                                |
| Style:                         |
| [â–¾ Photorealistic            ] |
|                                |
| [   ðŸª„ Generate Image        ] |
|      or  Cooldown (3s)         |
|                                |
| +----------------------------+ |
| |                            | |
| |    [Generated Image]       | |
| |                            | |
| +----------------------------+ |
| [    âœ“ Insert into Book     ]  |
+--------------------------------+
```

---

## Technical Notes

### Pollinations.ai API
- **URL Pattern**: `https://image.pollinations.ai/prompt/[ENCODED_PROMPT]?width=1024&height=1024&model=flux&nologo=true`
- **No API Key Required**: Direct URL-based generation
- **Licensing**: Public Domain - free for commercial use
- **Rate Limiting**: 5-second client-side cooldown to prevent abuse

### Style Presets
| Style | Appended Keywords |
|-------|-------------------|
| Watercolor Sketch | "watercolor style, white background, artistic" |
| Photorealistic | "highly detailed, 8k, realistic" |
| Line Art/Diagram | "black and white, vector line art, minimal" |

### Source Badge Colors (for ImageGrid)
```typescript
case 'pollinations': return 'bg-violet-600 text-white'; // New purple color for AI
```
